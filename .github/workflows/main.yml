name: Build DroidShield Ecosystem
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # --- JOB 1: CLIENT (AGENT) ---
  build-client:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Client APK
        # We run the command directly in the official Kivy container
        # This bypasses the permission bugs in the other actions
        run: |
          # Fix permissions for the folder so Docker can write to it
          sudo chmod -R 777 client_app
          
          # Run Buildozer inside Docker
          docker run --rm \
            -v ${{ github.workspace }}/client_app:/home/user/hostcwd \
            kivy/buildozer \
            android debug

      - name: Upload Client APK
        uses: actions/upload-artifact@v4
        with:
          name: DroidShield-Client-APK
          path: client_app/bin/*.apk

  # --- JOB 2: HQ (SERVER) ---
  build-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Server APK
        run: |
          # Fix permissions
          sudo chmod -R 777 server_app
          
          # Run Buildozer inside Docker
          docker run --rm \
            -v ${{ github.workspace }}/server_app:/home/user/hostcwd \
            kivy/buildozer \
            android debug

      - name: Upload Server APK
        uses: actions/upload-artifact@v4
        with:
          name: DroidShield-HQ-APK
          path: server_app/bin/*.apk
